# å·¥ä½œæµåç§°ï¼šè‡ªåŠ¨æ„å»ºä¸å‘å¸ƒæµç¨‹
# æ–‡ä»¶ä½ç½®ï¼š.github/workflows/build.yml
#
# åŠŸèƒ½è¯´æ˜ï¼š
# 1. è‡ªåŠ¨æ¨¡å¼ï¼ˆæ¨é€åˆ° mainï¼‰ï¼š
#    - åˆ›å»º GitHub é¢„å‘å¸ƒ
#    - æ¨é€ Docker beta æ ‡ç­¾
#    - è‡ªåŠ¨å¢åŠ ç‰ˆæœ¬å·
# 
# 2. æ‰‹åŠ¨æ¨¡å¼ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰ï¼š
#    - betaï¼šè¡Œä¸ºåŒè‡ªåŠ¨æ¨¡å¼
#    - releaseï¼šåˆ›å»ºæ­£å¼å‘å¸ƒï¼Œæ¨é€ latest æ ‡ç­¾
#
# 3. PR æ¨¡å¼ï¼š
#    - ä»…æ‰§è¡Œä»£ç æ£€æŸ¥å’Œæ„å»ºæµ‹è¯•
#    - ä¸åˆ›å»ºæ ‡ç­¾å’Œå‘å¸ƒ
#    - ä¸æ¨é€ Docker é•œåƒ
#
# é¡¹ç›®è¦æ±‚ï¼š
# 1. Go é¡¹ç›®ç»“æ„ï¼š
#    - å¿…é¡»æœ‰ main.go ä½œä¸ºå…¥å£æ–‡ä»¶
#    - å¿…é¡»åœ¨ main åŒ…ä¸­å®šä¹‰ Version å˜é‡
#    - å»ºè®®ä½¿ç”¨ Go modules (go.mod)
#
# 2. Docker è¦æ±‚ï¼š
#    - å¿…é¡»åœ¨æ ¹ç›®å½•æä¾› Dockerfile
#    - Dockerfile å¿…é¡»æ”¯æŒå¤šå¹³å°æ„å»º
#    - å»ºè®®ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–é•œåƒå¤§å°
#
# 3. æƒé™è¦æ±‚ï¼š
#    - GitHub Token æƒé™ï¼ˆè‡ªåŠ¨é…ç½®ï¼‰
#    - Docker Hub å¯†é’¥é…ç½®
#    
# 4. å‚è€ƒçš„ Dockerfile ç¤ºä¾‹ï¼š
# ```dockerfile
# FROM golang:1.22 AS builder
# WORKDIR /app
# COPY . .
# RUN go mod download
# RUN CGO_ENABLED=0 go build -o hubp
#
# FROM alpine:latest
# WORKDIR /app
# COPY --from=builder /app/hubp .
# ENTRYPOINT ["/app/hubp"]
# ```

name: è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒæµç¨‹

# è§¦å‘æ¡ä»¶é…ç½®
on:
  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths-ignore:  # å¿½ç•¥ä»¥ä¸‹æ–‡ä»¶çš„å˜æ›´
      - '*.md'                    # å¿½ç•¥æ‰€æœ‰ markdown æ–‡ä»¶
      - 'docs/**'                 # å¿½ç•¥æ–‡æ¡£ç›®å½•
      - '.github/*.md'            # å¿½ç•¥ GitHub ç›¸å…³æ–‡æ¡£
      - 'LICENSE'                 # å¿½ç•¥è®¸å¯è¯æ–‡ä»¶
      - '.gitignore'              # å¿½ç•¥ Git å¿½ç•¥æ–‡ä»¶
      - '.editorconfig'           # å¿½ç•¥ç¼–è¾‘å™¨é…ç½®
  
  # PR åˆ° main åˆ†æ”¯æ—¶è§¦å‘æ£€æŸ¥
  pull_request:
    branches: [ main ]
    paths-ignore:  # åŒä¸Šå¿½ç•¥é…ç½®
      - '*.md'
      - 'docs/**'
      - '.github/*.md'
      - 'LICENSE'
      - '.gitignore'
      - '.editorconfig'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹ (beta=é¢„å‘å¸ƒ, release=æ­£å¼å‘å¸ƒ)'
        required: true
        default: 'beta'
        type: choice
        options:
          - beta     # é¢„å‘å¸ƒç‰ˆæœ¬
          - release  # æ­£å¼å‘å¸ƒç‰ˆæœ¬

# ç¯å¢ƒæƒé™é…ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»ºå‘å¸ƒå’Œæ ‡ç­¾
  packages: write  # å…è®¸æ¨é€åˆ° GitHub Packages

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  # æ„å»ºé…ç½®
  GO_VERSION: '1.22.0'           # Go ç‰ˆæœ¬
  BINARY_NAME: 'HubP'            # äºŒè¿›åˆ¶æ–‡ä»¶å
  DOCKER_IMAGE: 'hubp'           # Docker é•œåƒå
  PLATFORMS: linux/amd64,linux/arm64  # Docker æ”¯æŒçš„å¹³å°
  
  # ç¼“å­˜é…ç½®
  GOCACHE: /tmp/go-cache        # Go æ„å»ºç¼“å­˜ç›®å½•
  GOMODCACHE: /tmp/go-mod-cache # Go æ¨¡å—ç¼“å­˜ç›®å½•
  
  # æ„å»ºä¼˜åŒ–
  CGO_ENABLED: 0                # ç¦ç”¨ CGOï¼Œä½¿ç”¨çº¯ Go å®ç°
  GOOS: ''                      # åœ¨å…·ä½“ä»»åŠ¡ä¸­è®¾ç½®
  GOARCH: ''                    # åœ¨å…·ä½“ä»»åŠ¡ä¸­è®¾ç½®

jobs:
  # ç‰ˆæœ¬æ§åˆ¶ä»»åŠ¡
  version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump_version.outputs.new_version }}            # æ–°ç‰ˆæœ¬å·
      is_manual_release: ${{ github.event_name == 'workflow_dispatch' }}    # æ˜¯å¦æ‰‹åŠ¨è§¦å‘
      is_release: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'release' }}  # æ˜¯å¦æ­£å¼å‘å¸ƒ
    steps:
      - name: æ£€å‡ºä»£ç  ğŸ“¥
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç‰ˆæœ¬è®¡ç®—
          
      - name: è·å–æœ€æ–°ç‰ˆæœ¬ ğŸ·ï¸
        id: get_latest
        run: |
          # è·å–æœ€æ–°æ ‡ç­¾ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ v0.0.0
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=${latest_tag}" >> $GITHUB_OUTPUT
          echo "å½“å‰ç‰ˆæœ¬: ${latest_tag}"
          
      - name: ç”Ÿæˆæ–°ç‰ˆæœ¬å· ğŸ“
        id: bump_version
        shell: bash
        run: |
          latest_tag="${{ steps.get_latest.outputs.latest_tag }}"
          version="${latest_tag#v}"  # ç§»é™¤ v å‰ç¼€
          
          # è§£æç‰ˆæœ¬å·ç»„ä»¶
          major=$(echo "$version" | cut -d. -f1)
          minor=$(echo "$version" | cut -d. -f2)
          patch=$(echo "$version" | cut -d. -f3)
          
          # å¢åŠ ä¿®è®¢å·
          patch=$((patch + 1))
          new_version="v${major}.${minor}.${patch}"
          
          echo "new_version=${new_version}" >> $GITHUB_OUTPUT
          echo "æ–°ç‰ˆæœ¬: ${new_version}"
          
      - name: åˆ›å»ºæ–°æ ‡ç­¾ ğŸ“Œ
        if: github.event_name != 'pull_request'  # PR æ—¶ä¸åˆ›å»ºæ ‡ç­¾
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          echo "åˆ›å»ºæ ‡ç­¾: ${{ steps.bump_version.outputs.new_version }}"
          git tag -a ${{ steps.bump_version.outputs.new_version }} -m "Release ${{ steps.bump_version.outputs.new_version }}"
          git push origin ${{ steps.bump_version.outputs.new_version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ä»£ç è´¨é‡æ£€æŸ¥
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç  ğŸ“¥
        uses: actions/checkout@v4

      - name: è®¾ç½® Go ç¯å¢ƒ ğŸ”§
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: ä»£ç æ£€æŸ¥ ğŸ”
        run: |
          # åŸºæœ¬ä»£ç æ£€æŸ¥
          if [ -f go.mod ]; then
            echo "æ‰§è¡Œ go fmt..."
            go fmt ./...
            echo "æ‰§è¡Œ go vet..."
            go vet ./...
          else
            echo "è­¦å‘Šï¼šæœªæ‰¾åˆ° go.mod æ–‡ä»¶"
            exit 1
          fi
          
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶
          if [ ! -f "main.go" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° main.go æ–‡ä»¶"
            exit 1
          fi
          
          if [ ! -f "Dockerfile" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° Dockerfile"
            exit 1
          fi

  # å¤šå¹³å°æ„å»ºä»»åŠ¡
  build:
    needs: [version, lint]  # ä¾èµ–ç‰ˆæœ¬å’Œä»£ç æ£€æŸ¥ä»»åŠ¡
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # æŸä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°
      matrix:
        # ç›®æ ‡å¹³å°é…ç½®ï¼šosï¼ˆæ“ä½œç³»ç»Ÿï¼‰å’Œ archï¼ˆæ¶æ„ï¼‰
        os: [linux, darwin, windows, freebsd]
        arch: [amd64, arm64]
        # æ’é™¤ä¸æ”¯æŒçš„ç»„åˆï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        # exclude:
        #   - os: freebsd
        #     arch: arm64  # å¦‚æœä¸æ”¯æŒè¿™ä¸ªç»„åˆï¼Œå–æ¶ˆæ³¨é‡Š
    steps:
      - name: æ£€å‡ºä»£ç  ğŸ“¥
        uses: actions/checkout@v4

      - name: åˆå§‹åŒ– Go ç¯å¢ƒ ğŸ”§
        run: |
          # åˆ›å»ºå¿…è¦çš„æ„å»ºæ–‡ä»¶
          if [ ! -f "go.mod" ]; then
            go mod init ${{ env.BINARY_NAME }}
          fi
          if [ ! -f "go.sum" ]; then
            touch go.sum
          fi
          
          # åˆ›å»ºç¼“å­˜ç›®å½•
          mkdir -p ${{ env.GOCACHE }}
          mkdir -p ${{ env.GOMODCACHE }}

      - name: è®¾ç½® Go ç¯å¢ƒ ğŸ› ï¸
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: å‡†å¤‡ä¾èµ– ğŸ“¦
        run: |
          echo "æ•´ç† Go æ¨¡å—..."
          go mod tidy
          echo "ä¸‹è½½ä¾èµ–..."
          go mod download
          
      - name: æ„å»ºç¨‹åº ğŸ—ï¸
        run: |
          VERSION=${{ needs.version.outputs.new_version }}
          mkdir -p release
          binary_name="${{ env.BINARY_NAME }}"
          
          # Windows å¹³å°ç‰¹æ®Šå¤„ç†
          if [ "${{ matrix.os }}" = "windows" ]; then
            binary_name="${binary_name}.exe"
          fi
          
          # æ„å»ºç›®å½•
          temp_dir="release/${{ env.BINARY_NAME }}-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}"
          mkdir -p "${temp_dir}"
          
          echo "å¼€å§‹æ„å»º ${{ matrix.os }}/${{ matrix.arch }}..."
          
          # æ‰§è¡Œæ„å»ºï¼Œæ·»åŠ ç‰ˆæœ¬ä¿¡æ¯
          GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} \
          go build -trimpath \
            -ldflags="-s -w -X main.Version=${VERSION}" \
            -o "${temp_dir}/${binary_name}" .
          
          # æ‰“åŒ…å’Œæ ¡éªŒ
          cd release
          echo "åˆ›å»ºå‹ç¼©åŒ…..."
          zip -9 "${{ env.BINARY_NAME }}-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}.zip" \
            -r "$(basename ${temp_dir})"/*
          
          echo "ç”Ÿæˆæ ¡éªŒå’Œ..."
          sha256sum "${{ env.BINARY_NAME }}-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}.zip" \
            | tee -a "checksums-${{ matrix.os }}-${{ matrix.arch }}.txt"
          
      - name: ä¸Šä¼ æ„å»ºäº§ç‰© ğŸ“¤
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}-${{ matrix.arch }}
          path: release/*
          retention-days: 1

  # Docker æ„å»ºä»»åŠ¡
  docker:
    needs: [version, lint]  # ä¾èµ–ç‰ˆæœ¬å’Œä»£ç æ£€æŸ¥ä»»åŠ¡
    if: github.event_name != 'pull_request'  # PR æ—¶ä¸æ„å»º Docker
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç  ğŸ“¥
        uses: actions/checkout@v4

      - name: è®¾ç½® QEMU ğŸ³
        uses: docker/setup-qemu-action@v3
        
      - name: è®¾ç½® Docker Buildx ğŸ› ï¸
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•åˆ° Docker Hub ğŸ”‘
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Beta ç‰ˆæœ¬æ„å»ºï¼ˆè‡ªåŠ¨è¿è¡Œæˆ–æ‰‹åŠ¨é€‰æ‹© betaï¼‰
      - name: æ„å»º Beta ç‰ˆæœ¬ ğŸš§
        if: needs.version.outputs.is_release != 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ needs.version.outputs.new_version }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:beta
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # æ„å»ºå‚æ•°
          build-args: |
            VERSION=${{ needs.version.outputs.new_version }}
            GO_VERSION=${{ env.GO_VERSION }}

      # æ­£å¼ç‰ˆæœ¬æ„å»ºï¼ˆä»…åœ¨æ‰‹åŠ¨é€‰æ‹© release æ—¶ï¼‰
      - name: æ„å»ºæ­£å¼ç‰ˆæœ¬ ğŸš€
        if: needs.version.outputs.is_release == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ needs.version.outputs.new_version }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # æ„å»ºå‚æ•°
          build-args: |
            VERSION=${{ needs.version.outputs.new_version }}
            GO_VERSION=${{ env.GO_VERSION }}

  # åˆ›å»ºå‘å¸ƒ
  release:
    needs: [version, build, docker]
    if: github.event_name != 'pull_request'  # PR æ—¶ä¸åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰© ğŸ“¥
        uses: actions/download-artifact@v4
        with:
          path: release
          pattern: release-*
          merge-multiple: true
          
      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶ ğŸ“‹
        run: |
          mkdir -p final_release
          # å¤åˆ¶æ‰€æœ‰ zip æ–‡ä»¶
          find release -name "*.zip" -exec cp {} final_release/ \;
          # åˆå¹¶æ‰€æœ‰æ ¡éªŒå’Œ
          echo "## SHA256 æ ¡éªŒå’Œ" > final_release/checksums.txt
          find release -name "checksums-*.txt" -exec cat {} >> final_release/checksums.txt \;
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          {
            if [ "${{ needs.version.outputs.is_release }}" = "true" ]; then
              echo "# ğŸš€ æ­£å¼å‘å¸ƒ ${{ needs.version.outputs.new_version }}"
              echo ""
            else
              echo "# ğŸš§ é¢„å‘å¸ƒ ${{ needs.version.outputs.new_version }}"
              echo ""
            fi
            echo ""
            echo "## ğŸ“¦ æ”¯æŒçš„å¹³å°"
            echo "- Linux (AMD64, ARM64)"
            echo "- macOS (AMD64, ARM64)"
            echo "- Windows (AMD64, ARM64)"
            echo "- FreeBSD (AMD64, ARM64)"
            echo ""
            echo "## ğŸ³ Docker é•œåƒ"
            echo "æ”¯æŒçš„æ¶æ„ï¼šAMD64, ARM64"
            echo ""
            echo "### è·å–æ–¹å¼"
            echo "\`\`\`bash"
            if [ "${{ needs.version.outputs.is_release }}" = "true" ]; then
              echo "# ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆ"
              echo "docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest"
              echo ""
              echo "# ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬"
              echo "docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ needs.version.outputs.new_version }}"
            else
              echo "# ä½¿ç”¨æœ€æ–°æµ‹è¯•ç‰ˆ"
              echo "docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:beta"
              echo ""
              echo "# ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬"
              echo "docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ needs.version.outputs.new_version }}"
            fi
            echo "\`\`\`"
            echo ""
            cat final_release/checksums.txt
          } > final_release/release_notes.md
          
      - name: åˆ›å»ºå‘å¸ƒ ğŸ“¢
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.new_version }}
          files: |
            final_release/*.zip
            final_release/checksums.txt
          body_path: final_release/release_notes.md
          draft: false
          # è‡ªåŠ¨è¿è¡Œæˆ–æ‰‹åŠ¨é€‰æ‹© beta æ—¶åˆ›å»ºé¢„å‘å¸ƒï¼Œæ‰‹åŠ¨é€‰æ‹© release æ—¶åˆ›å»ºæ­£å¼å‘å¸ƒ
          prerelease: ${{ needs.version.outputs.is_release != 'true' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
