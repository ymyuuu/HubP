name: è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒæµç¨‹

################################################################################
# è§¦å‘æ¡ä»¶ï¼š                                                                     
#   1. push åˆ° main åˆ†æ”¯ï¼šåªæ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥å’Œå¤šå¹³å°æ„å»ºï¼ˆä¸æ¨é€ Dockerã€ä¸åˆ›å»ºæ ‡ç­¾å’Œå‘å¸ƒï¼‰
#   2. pull_request åˆ° main åˆ†æ”¯ï¼šåªæ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥å’Œå¤šå¹³å°æ„å»ºï¼ˆä¸æ¨é€ Dockerã€ä¸åˆ›å»ºæ ‡ç­¾å’Œå‘å¸ƒï¼‰
#   3. æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰ï¼Œé€šè¿‡è¾“å…¥å‚æ•°å†³å®šå‘å¸ƒç±»å‹ï¼š                         
#      - betaï¼šåˆ›å»ºé¢„å‘å¸ƒå¹¶æ¨é€ beta æ ‡ç­¾                                    
#      - releaseï¼šåˆ›å»ºæ­£å¼å‘å¸ƒå¹¶æ¨é€ latest æ ‡ç­¾                              
################################################################################

on:
  # å½“æœ‰ä»£ç  push åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.github/*.md'
      - 'LICENSE'
      - '.gitignore'
      - '.editorconfig'

  # å½“æœ‰ PRï¼ˆPull Requestï¼‰åˆå¹¶åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.github/*.md'
      - 'LICENSE'
      - '.gitignore'
      - '.editorconfig'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹ (beta=é¢„å‘å¸ƒ, release=æ­£å¼å‘å¸ƒ)'
        required: true
        default: 'beta'
        type: choice
        options:
          - beta
          - release

################################################################################
# å·¥ä½œæµæƒé™é…ç½®ï¼šå…è®¸åˆ›å»ºæ ‡ç­¾/å‘å¸ƒï¼Œæ¨é€åˆ° Packages ç­‰
################################################################################
permissions:
  contents: write
  packages: write

################################################################################
# å…¨å±€ç¯å¢ƒå˜é‡
################################################################################
env:
  # Go åŸºç¡€ç‰ˆæœ¬
  GO_VERSION: '1.22.0'
  
  # äºŒè¿›åˆ¶æ–‡ä»¶åç§°
  BINARY_NAME: 'HubP'

  # Docker é•œåƒåç§°ï¼ˆæ„å»ºæ—¶ä½¿ç”¨ï¼‰
  DOCKER_IMAGE: 'hubp'
  
  # Docker æ”¯æŒçš„å¹³å°ï¼ˆå¤šæ¶æ„ï¼‰
  PLATFORMS: linux/amd64,linux/arm64

################################################################################
# Job 1: ç‰ˆæœ¬å¤„ç†ï¼ˆæ ¹æ®æ˜¯å¦æ‰‹åŠ¨è§¦å‘ï¼Œå†³å®šæ˜¯å¦è‡ªåŠ¨ç”Ÿæˆæ–°ç‰ˆæœ¬å¹¶åˆ›å»ºæ ‡ç­¾ï¼‰
################################################################################
jobs:
  version:
    name: ç‰ˆæœ¬å¤„ç†
    runs-on: ubuntu-latest

    outputs:
      # å¯¹å¤–è¾“å‡ºï¼šæœ€ç»ˆç”¨äºæ„å»ºæ—¶æ‰€éœ€çš„ç‰ˆæœ¬å·
      final_version: ${{ steps.set_version.outputs.final_version }}
      # å¯¹å¤–è¾“å‡ºï¼šæ˜¯å¦ä¸ºæ‰‹åŠ¨è§¦å‘
      is_manual: ${{ github.event_name == 'workflow_dispatch' }}
      # å¯¹å¤–è¾“å‡ºï¼šæ˜¯å¦ä¸ºæ­£å¼å‘å¸ƒï¼ˆä»…æ‰‹åŠ¨è§¦å‘ + release_type=releaseï¼‰
      is_release: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'release' }}

    steps:
      - name: æ£€å‡ºä»£ç  ğŸ“¥
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²ï¼Œä¾¿äºåç»­å¯èƒ½çš„ç‰ˆæœ¬è®¡ç®—

      - name: è®¾ç½®ä¸´æ—¶æˆ–çœŸå®ç‰ˆæœ¬å·
        id: set_version
        shell: bash
        run: |
          # å¦‚æœä¸æ˜¯æ‰‹åŠ¨è§¦å‘ï¼ˆå³ push æˆ– PRï¼‰ï¼Œæˆ‘ä»¬åªä½¿ç”¨ä¸€ä¸ªä¸´æ—¶ç‰ˆæœ¬å·ï¼Œä¸åˆ›å»ºæ ‡ç­¾
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "å½“å‰è§¦å‘å¹¶éæ‰‹åŠ¨æ¨¡å¼ï¼Œä½¿ç”¨ä¸´æ—¶ç‰ˆæœ¬å· v0.0.0-snapshot"
            echo "final_version=v0.0.0-snapshot" >> $GITHUB_OUTPUT
            exit 0
          fi

          #-------------------------
          # ä»¥ä¸‹é€»è¾‘ä»…åœ¨æ‰‹åŠ¨è§¦å‘æ—¶æ‰§è¡Œ
          #-------------------------
          # 1. å–å¾—æœ€æ–°æ ‡ç­¾ï¼ˆå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º v0.0.0ï¼‰
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "è·å–åˆ°çš„æœ€æ–°æ ‡ç­¾: ${latest_tag}"

          # 2. ç§»é™¤ v å‰ç¼€å¹¶è¿›è¡Œåˆ†å‰²ï¼Œæ‹†å‡º major.minor.patch
          version="${latest_tag#v}"
          major=$(echo "$version" | cut -d. -f1)
          minor=$(echo "$version" | cut -d. -f2)
          patch=$(echo "$version" | cut -d. -f3)

          # 3. patch å· +1
          patch=$((patch + 1))
          new_version="v${major}.${minor}.${patch}"

          # å°†ç”Ÿæˆçš„æ–°ç‰ˆæœ¬å·è¾“å‡º
          echo "ç”Ÿæˆçš„æ–°ç‰ˆæœ¬å·: $new_version"
          echo "final_version=$new_version" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºå¹¶æ¨é€æ–°æ ‡ç­¾ï¼ˆä»…æ‰‹åŠ¨è§¦å‘æ—¶ï¼‰
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          # ä»ä¸Šä¸€æ­¥è·å–æ–°ç‰ˆæœ¬å·
          version="${{ steps.set_version.outputs.final_version }}"
          echo "å‡†å¤‡æ¨é€æ ‡ç­¾: ${version}"

          # é…ç½® git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "${version}" -m "Release ${version}"
          git push origin "${version}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

################################################################################
# Job 2: ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆlintï¼‰
################################################################################
  lint:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç  ğŸ“¥
        uses: actions/checkout@v4

      - name: å®‰è£…æŒ‡å®šç‰ˆæœ¬ Go ç¯å¢ƒ ğŸ”§
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          # ä¸ä½¿ç”¨ç¼“å­˜
          cache: false

      - name: ä»£ç æ ¼å¼ä¸é™æ€æ£€æŸ¥ ğŸ”
        run: |
          # æ£€æµ‹ go.mod æ˜¯å¦å­˜åœ¨
          if [ ! -f "go.mod" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° go.mod æ–‡ä»¶ï¼Œæ— æ³•è¿›è¡Œ Go é¡¹ç›®çš„ä¾èµ–ç®¡ç†ã€‚"
            exit 1
          fi

          # è¿›è¡Œ go fmt
          echo "å¼€å§‹æ‰§è¡Œ go fmt..."
          go fmt ./...
          echo "go fmt æ‰§è¡Œå®Œæ¯•ã€‚"

          # è¿›è¡Œ go vet
          echo "å¼€å§‹æ‰§è¡Œ go vet..."
          go vet ./...
          echo "go vet æ‰§è¡Œå®Œæ¯•ã€‚"

          # æ£€æŸ¥ main.go æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "main.go" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° main.go å…¥å£æ–‡ä»¶ã€‚"
            exit 1
          fi

          # æ£€æŸ¥ Dockerfile æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "Dockerfile" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° Dockerfile æ–‡ä»¶ã€‚"
            exit 1
          fi

################################################################################
# Job 3: å¤šå¹³å°æ„å»ºï¼ˆåªè´Ÿè´£äº§ç‰©æ„å»ºä¸æ‰“åŒ…ï¼Œä¸æ¨é€ Dockerï¼‰
################################################################################
  build:
    name: å¤šå¹³å°æ„å»º
    needs: [version, lint]  # ä¾èµ–ç‰ˆæœ¬å¤„ç†å’Œä»£ç è´¨é‡æ£€æŸ¥

    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        os: [linux, darwin, windows, freebsd]
        arch: [amd64, arm64]
        # å¦‚éœ€æ’é™¤ç‰¹å®šç»„åˆï¼Œå¯åœ¨æ­¤ä½¿ç”¨ exclude

    steps:
      - name: æ£€å‡ºä»£ç  ğŸ“¥
        uses: actions/checkout@v4

      - name: è®¾ç½® Go ç¯å¢ƒ ğŸ› 
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          # ä¸ä½¿ç”¨ç¼“å­˜
          cache: false

      - name: å‡†å¤‡ Go æ¨¡å—ä¾èµ–
        run: |
          # å¦‚æœæ²¡æœ‰ go.modï¼Œåˆ™åˆå§‹åŒ–
          if [ ! -f "go.mod" ]; then
            go mod init ${{ env.BINARY_NAME }}
          fi
          # å¦‚æœæ²¡æœ‰ go.sumï¼Œåˆ™åˆ›å»º
          if [ ! -f "go.sum" ]; then
            touch go.sum
          fi

          echo "ä¸‹è½½ä¾èµ–..."
          go mod tidy
          go mod download

      - name: æ„å»ºä¸æ‰“åŒ…
        run: |
          # ä» version Job è·å–æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„ç‰ˆæœ¬å·
          VERSION=${{ needs.version.outputs.final_version }}
          echo "ä½¿ç”¨ç‰ˆæœ¬å·ï¼š${VERSION}"

          # ç»Ÿä¸€æ”¾åœ¨ release ç›®å½•
          mkdir -p release

          # æ„å»ºå‡ºçš„æœ€ç»ˆäºŒè¿›åˆ¶åç§°ï¼ˆåŒºåˆ† Windows åç¼€ï¼‰
          binary_name="${{ env.BINARY_NAME }}"
          if [ "${{ matrix.os }}" = "windows" ]; then
            binary_name="${binary_name}.exe"
          fi

          # æ„å»ºè¾“å‡ºçš„ä¸´æ—¶ç›®å½•ï¼šä¾‹å¦‚ release/HubP-v1.0.1-linux-amd64
          temp_dir="release/${{ env.BINARY_NAME }}-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}"
          mkdir -p "${temp_dir}"

          echo "å¼€å§‹æ„å»º -> OS: ${{ matrix.os }}, ARCH: ${{ matrix.arch }}"

          # è®¾ç½®ç›®æ ‡å¹³å°å¹¶è¿›è¡Œæ„å»ºï¼ˆæ³¨å…¥ç‰ˆæœ¬å˜é‡ main.Versionï¼‰
          GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} \
            go build \
            -trimpath \
            -ldflags="-s -w -X main.Version=${VERSION}" \
            -o "${temp_dir}/${binary_name}" \
            .

          echo "æ„å»ºå®Œæˆã€‚å¼€å§‹æ‰“åŒ…..."

          # è¿›å…¥ release ç›®å½•è¿›è¡Œåç»­æ“ä½œ
          cd release

          # å‹ç¼©åŒ…åç§°ï¼Œä¾‹å¦‚ï¼šHubP-v1.0.1-linux-amd64.zip
          zip_file="${{ env.BINARY_NAME }}-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}.zip"

          # åˆ›å»º zip å‹ç¼©åŒ…
          zip -9 "${zip_file}" -r "$(basename ${temp_dir})"

          # ç”Ÿæˆæ ¡éªŒå’Œ
          sha256sum "${zip_file}" | tee -a "checksums-${{ matrix.os }}-${{ matrix.arch }}.txt"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}-${{ matrix.arch }}
          path: release
          retention-days: 1

################################################################################
# Job 4: Docker æ„å»ºä¸æ¨é€ï¼ˆä»…åœ¨æ‰‹åŠ¨è§¦å‘æ—¶è¿›è¡Œæ¨é€ï¼‰
################################################################################
  docker:
    name: Docker æ„å»ºä¸æ¨é€
    needs: [version, lint]  # ä¸éœ€è¦ä¾èµ– build Jobï¼Œå› ä¸º build Job ä»…åšäºŒè¿›åˆ¶äº§ç‰©æµ‹è¯•
    if: ${{ github.event_name == 'workflow_dispatch' }}  # åªæœ‰æ‰‹åŠ¨è§¦å‘æ‰è¿›è¡Œ Docker æ„å»ºæ¨é€

    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç  ğŸ“¥
        uses: actions/checkout@v4

      - name: è®¾ç½® QEMUï¼ˆå¤šæ¶æ„æ”¯æŒï¼‰
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Hub ç™»å½•
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒï¼ˆbeta æˆ–é¢„å‘å¸ƒï¼‰
        if: ${{ needs.version.outputs.is_release != 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ env.PLATFORMS }}
          push: true
          # æ— ç¼“å­˜
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ needs.version.outputs.final_version }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:beta
          build-args: |
            VERSION=${{ needs.version.outputs.final_version }}
            GO_VERSION=${{ env.GO_VERSION }}

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒï¼ˆæ­£å¼å‘å¸ƒï¼‰
        if: ${{ needs.version.outputs.is_release == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ env.PLATFORMS }}
          push: true
          # æ— ç¼“å­˜
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ needs.version.outputs.final_version }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest
          build-args: |
            VERSION=${{ needs.version.outputs.final_version }}
            GO_VERSION=${{ env.GO_VERSION }}

################################################################################
# Job 5: åˆ›å»º GitHub Releaseï¼ˆä»…åœ¨æ‰‹åŠ¨è§¦å‘æ—¶æ‰§è¡Œï¼‰
################################################################################
  release:
    name: åˆ›å»ºå‘å¸ƒ
    needs: [version, build, docker]
    if: ${{ github.event_name == 'workflow_dispatch' }}  # ä»…åœ¨æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œ

    runs-on: ubuntu-latest

    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: release
          pattern: build-*
          merge-multiple: true

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p final_release
          # æ”¶é›†æ‰€æœ‰çš„ zip åŒ…
          find release -name "*.zip" -exec cp {} final_release/ \;

          # åˆå¹¶æ‰€æœ‰çš„æ ¡éªŒå’Œæ–‡ä»¶
          echo "## SHA256 æ ¡éªŒå’Œ" > final_release/checksums.txt
          find release -name "checksums-*.txt" -exec cat {} >> final_release/checksums.txt \;

          # å‡†å¤‡å‘å¸ƒè¯´æ˜
          {
            if [ "${{ needs.version.outputs.is_release }}" = "true" ]; then
              echo "# ğŸš€ æ­£å¼å‘å¸ƒ ${{ needs.version.outputs.final_version }}"
              echo ""
            else
              echo "# ğŸš§ é¢„å‘å¸ƒ ${{ needs.version.outputs.final_version }}"
              echo ""
            fi
            echo "## æ”¯æŒçš„å¹³å°"
            echo "- Linux (AMD64, ARM64)"
            echo "- macOS (AMD64, ARM64)"
            echo "- Windows (AMD64, ARM64)"
            echo "- FreeBSD (AMD64, ARM64)"
            echo ""
            echo "## Docker é•œåƒ"
            echo "å¯ç”¨çš„å¤šæ¶æ„ï¼šAMD64, ARM64"
            echo ""
            if [ "${{ needs.version.outputs.is_release }}" = "true" ]; then
              echo "### æ‹‰å–æœ€æ–°ç¨³å®šç‰ˆ"
              echo "\`\`\`bash"
              echo "docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest"
              echo "docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ needs.version.outputs.final_version }}"
              echo "\`\`\`"
            else
              echo "### æ‹‰å–æµ‹è¯•ç‰ˆ"
              echo "\`\`\`bash"
              echo "docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:beta"
              echo "docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ needs.version.outputs.final_version }}"
              echo "\`\`\`"
            fi
            echo ""
            echo "## æ ¡éªŒå’Œ"
            cat final_release/checksums.txt
          } > final_release/release_notes.md

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.final_version }}
          files: |
            final_release/*.zip
            final_release/checksums.txt
          body_path: final_release/release_notes.md
          draft: false
          # å¦‚æœæ˜¯æ­£å¼å‘å¸ƒåˆ™ä¸è®¾ä¸ºé¢„å‘å¸ƒï¼Œå¦åˆ™ä¸ºé¢„å‘å¸ƒ
          prerelease: ${{ needs.version.outputs.is_release != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
