################################################################################
# å·¥ä½œæµåç§°ï¼šè‡ªåŠ¨æ„å»ºä¸å‘å¸ƒæµç¨‹
# æ–‡ä»¶è·¯å¾„ï¼š.github/workflows/build.yml
#
# åŠŸèƒ½è¯´æ˜ï¼š
# 1. push æˆ– pull_request åˆ° main åˆ†æ”¯ï¼š
#    - åªæ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥ï¼ˆlintï¼‰å’Œå¤šå¹³å°æ„å»ºï¼ˆbuildï¼‰ä»»åŠ¡
#    - ä¸æ¨é€ Docker é•œåƒã€ä¸åˆ›å»ºæ ‡ç­¾ã€ä¸åˆ›å»º Release
#
# 2. æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)ï¼š
#    - å¯ä»¥é€šè¿‡é€‰æ‹© release_type å‚æ•°ï¼ˆBeta æˆ– Releasesï¼‰
#      * release_type=Betaï¼šé¢„å‘å¸ƒï¼›Docker é•œåƒæ¨é€è‡³ beta æ ‡ç­¾
#      * release_type=Releasesï¼šæ­£å¼å‘å¸ƒï¼›Docker é•œåƒæ¨é€è‡³ latest æ ‡ç­¾
#    - è‡ªåŠ¨æ ¹æ®æœ€æ–°çš„ Git Tag ç‰ˆæœ¬å· +1ï¼Œåˆ›å»ºå¹¶æ¨é€æ–°æ ‡ç­¾
#    - æ ¹æ®é€‰æ‹©åˆ›å»ºå¯¹åº”çš„ GitHub Releaseï¼ˆé¢„å‘å¸ƒæˆ–æ­£å¼å‘å¸ƒï¼‰
#    - æ¨é€ Docker å¤šæ¶æ„é•œåƒè‡³ Docker Hub
#
# 3. Go é¡¹ç›® & Docker çº¦æŸï¼š
#    - main.go ä½œä¸ºå…¥å£æ–‡ä»¶ï¼Œä¸”åœ¨ main åŒ…ä¸­å®šä¹‰ Version å˜é‡
#    - Dockerfile å¿…é¡»æ”¯æŒå¤šå¹³å°æ„å»ºï¼ˆä½¿ç”¨ buildx + QEMUï¼‰
#    - å¦‚éœ€ä¼˜åŒ–é•œåƒå¤§å°ï¼Œå¯ä½¿ç”¨å¤šé˜¶æ®µæ„å»º
#
# 4. å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼š
#    - è‹¥æ²¡æœ‰ go.mod æ–‡ä»¶ï¼Œå°†è‡ªåŠ¨æ‰§è¡Œ go mod initï¼›å¯èƒ½éœ€è¦æ ¹æ®å®é™…é¡¹ç›®åŒ…åè¿›è¡Œå¾®è°ƒ
#    - freebsd åœ¨ arm64 ä¸‹æœ‰å¯èƒ½æ„å»ºå¤±è´¥ï¼ˆéœ€è§†å®é™…æƒ…å†µæ’é™¤è¯¥ç»„åˆï¼‰
#    - Windows å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶éœ€æ·»åŠ  .exe åç¼€
#
# 5. æé«˜å¯è¯»æ€§ä¸ç”¨æˆ·ä½“éªŒï¼š
#    - ä½¿ç”¨äº†éƒ¨åˆ† emoji å›¾æ ‡ï¼Œè®©è¾“å‡ºå’Œæ­¥éª¤åç§°æ›´åŠ ç›´è§‚
#    - å¯¹å…³é”®æ­¥éª¤è¿›è¡Œäº†ä¸­æ–‡æ³¨é‡Šè¯´æ˜ï¼Œæ–¹ä¾¿ç»´æŠ¤
################################################################################

name: è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒæµç¨‹

################################################################################
# è§¦å‘æ¡ä»¶é…ç½®
################################################################################
on:
  # å½“ push åˆ° main åˆ†æ”¯æ—¶ï¼šæ‰§è¡Œ lint + buildï¼Œä»…åšæµ‹è¯•å’Œæ£€æŸ¥
  push:
    branches: [ main ]

  # å½“æœ‰ PR (pull_request) åˆå¹¶åˆ° main æ—¶ï¼šæ‰§è¡Œ lint + buildï¼Œä»…åšæµ‹è¯•å’Œæ£€æŸ¥
  pull_request:
    branches: [ main ]

  # æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
  workflow_dispatch:
    inputs:
      release_type:
        description: 'é€‰æ‹©å‘å¸ƒç±»å‹ (Beta=é¢„å‘å¸ƒ, Releases=æ­£å¼å‘å¸ƒ)'
        required: true
        default: 'Beta'
        type: choice
        options:
          - Beta
          - Releases

################################################################################
# æƒé™é…ç½®ï¼šå…è®¸åˆ›å»ºæ ‡ç­¾ã€å‘å¸ƒå’Œæ¨é€åˆ° Packages
################################################################################
permissions:
  contents: write
  packages: write

################################################################################
# å…¨å±€ç¯å¢ƒå˜é‡
# - å¯åœ¨ä¸åŒ Job ä¸­é‡å¤ä½¿ç”¨
# - Docker å¤šå¹³å°æ„å»ºéœ€è¦åœ¨ docker/build-push-action ä¸­å¼•ç”¨
################################################################################
env:
  GO_VERSION: "1.22.0"          # Go ç‰ˆæœ¬
  BINARY_NAME: "HubP"           # äºŒè¿›åˆ¶æ–‡ä»¶å
  DOCKER_IMAGE: "hubp"          # Docker é•œåƒå
  PLATFORMS: "linux/amd64,linux/arm64"  # Docker å¤šå¹³å°æ„å»ºç›®æ ‡

################################################################################
# Job 1: ç‰ˆæœ¬å¤„ç† â€”â€” æ ¹æ®æ˜¯å¦æ‰‹åŠ¨è§¦å‘å†³å®šç‰ˆæœ¬å·ä¸æ ‡ç­¾åˆ›å»º
################################################################################
jobs:
  version:
    name: ç‰ˆæœ¬å¤„ç† ğŸ·ï¸
    runs-on: ubuntu-latest

    outputs:
      final_version: ${{ steps.version_step.outputs.final_version }}  # ä¸‹æ¸¸éœ€è¦çš„ç‰ˆæœ¬å·
      # æ˜¯å¦æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰
      is_manual: ${{ github.event_name == 'workflow_dispatch' }}
      # æ˜¯å¦æ­£å¼å‘å¸ƒï¼ˆä»…å½“æ‰‹åŠ¨è§¦å‘ && release_type=Releases æ‰ä¸º trueï¼‰
      is_release: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'Releases' }}

    steps:
      - name: æ£€å‡ºä»£ç  ğŸ“¥
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²ï¼Œä»¥ä¾¿è·å–æœ€æ–°æ ‡ç­¾

      - name: è®¾ç½®ç‰ˆæœ¬å·
        id: version_step
        shell: bash
        run: |
          ############################################################################
          # å¦‚æœä¸æ˜¯æ‰‹åŠ¨è§¦å‘ (push / pull_request)ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ä¸´æ—¶ç‰ˆæœ¬å·ï¼Œä¸åˆ›å»ºçœŸå®æ ‡ç­¾
          ############################################################################
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "å½“å‰ä¸º push æˆ– PR è§¦å‘ï¼Œä»…ä½¿ç”¨ä¸´æ—¶ç‰ˆæœ¬å· v0.0.0-snapshot"
            echo "final_version=v0.0.0-snapshot" >> $GITHUB_OUTPUT
            exit 0
          fi

          ############################################################################
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œåˆ™éœ€è¦:
          # 1. è·å–æœ€æ–°æ ‡ç­¾
          # 2. å°†è¡¥ä¸å· +1
          # 3. ç”Ÿæˆæ–°çš„ç‰ˆæœ¬å·å¹¶è¾“å‡º
          ############################################################################
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "è·å–åˆ°çš„æœ€æ–°æ ‡ç­¾: $latest_tag"

          version_no_v="${latest_tag#v}"    # å»æ‰å‰ç¼€ v
          major=$(echo "$version_no_v" | cut -d. -f1)
          minor=$(echo "$version_no_v" | cut -d. -f2)
          patch=$(echo "$version_no_v" | cut -d. -f3)

          patch=$((patch + 1))
          new_version="v${major}.${minor}.${patch}"

          echo "ç”Ÿæˆæ–°ç‰ˆæœ¬å·: $new_version"
          echo "final_version=$new_version" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºå¹¶æ¨é€æ–°æ ‡ç­¾
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          # ä»…åœ¨æ‰‹åŠ¨è§¦å‘æ—¶æ‰æ‰§è¡Œæ­¤æ­¥éª¤
          version="${{ steps.version_step.outputs.final_version }}"
          echo "å³å°†åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾: ${version}"
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "${version}" -m "Release ${version}"
          git push origin "${version}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

################################################################################
# Job 2: ä»£ç è´¨é‡æ£€æŸ¥ (lint)
################################################################################
  lint:
    name: ä»£ç è´¨é‡æ£€æŸ¥ ğŸ”
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç  ğŸ“¥
        uses: actions/checkout@v4

      - name: è®¾ç½® Go ç¯å¢ƒ ğŸ”§
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          # ä¸ä½¿ç”¨ç¼“å­˜
          cache: false

      - name: æ‰§è¡Œä»£ç æ ¼å¼åŒ– & é™æ€æ£€æŸ¥
        run: |
          # æ£€æŸ¥ go.mod
          if [ ! -f go.mod ]; then
            echo "é”™è¯¯ï¼šé¡¹ç›®æ ¹ç›®å½•ä¸‹æœªæ‰¾åˆ° go.mod æ–‡ä»¶ï¼Œæ— æ³•è¿›è¡Œä¾èµ–ç®¡ç†ã€‚"
            exit 1
          fi

          # go fmt
          echo "ğŸ”¹ å¼€å§‹æ‰§è¡Œ go fmt..."
          go fmt ./...
          echo "âœ… go fmt å®Œæˆã€‚"

          # go vet
          echo "ğŸ”¹ å¼€å§‹æ‰§è¡Œ go vet..."
          go vet ./...
          echo "âœ… go vet å®Œæˆã€‚"

          # æ ¸éªŒ main.go
          if [ ! -f "main.go" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° main.go å…¥å£æ–‡ä»¶ï¼"
            exit 1
          fi

          # æ ¸éªŒ Dockerfile
          if [ ! -f "Dockerfile" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° Dockerfile æ–‡ä»¶ï¼"
            exit 1
          fi

################################################################################
# Job 3: å¤šå¹³å°æ„å»º (build)
#  - ä»…è¿›è¡Œç¼–è¯‘ä¸äº§ç‰©æ‰“åŒ…ï¼Œç”¨äºæµ‹è¯•å„å¹³å°èƒ½å¦æˆåŠŸæ„å»º
#  - push æˆ– PR æ—¶ï¼šä¼šè§¦å‘è¿™ä¸€è¿‡ç¨‹ï¼Œä½†ä¸æ¨é€ Docker
################################################################################
  build:
    name: å¤šå¹³å°æ„å»º ğŸ—ï¸
    needs: [version, lint]  # å¿…é¡»å…ˆå®Œæˆç‰ˆæœ¬å¤„ç†å’Œä»£ç è´¨é‡æ£€æŸ¥

    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        os: [ linux, darwin, windows, freebsd ]
        arch: [ amd64, arm64 ]
        # å¦‚éœ€æ’é™¤æŸäº›ä¸å…¼å®¹ç»„åˆï¼Œå¯åœ¨æ­¤æ·»åŠ  exclude
        # exclude:
        #   - os: freebsd
        #     arch: arm64

    steps:
      - name: æ£€å‡ºä»£ç  ğŸ“¥
        uses: actions/checkout@v4

      - name: è®¾ç½® Go ç¯å¢ƒ ğŸ› 
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          # ä¸ä½¿ç”¨ç¼“å­˜
          cache: false

      - name: å‡†å¤‡ Go æ¨¡å—ä¾èµ–
        run: |
          if [ ! -f go.mod ]; then
            go mod init ${{ env.BINARY_NAME }}
          fi
          if [ ! -f go.sum ]; then
            touch go.sum
          fi
          
          echo "æ­£åœ¨ä¸‹è½½ä¾èµ–..."
          go mod tidy
          go mod download

      - name: æ„å»ºä¸æ‰“åŒ… ğŸ“¦
        run: |
          # å–å¾—ç‰ˆæœ¬å·ï¼ˆpush æˆ– PR æ—¶ä¸º v0.0.0-snapshotï¼›æ‰‹åŠ¨è§¦å‘åˆ™ä¸ºå®é™…ç‰ˆæœ¬ï¼‰
          VERSION=${{ needs.version.outputs.final_version }}
          echo "å½“å‰ä½¿ç”¨ç‰ˆæœ¬å·ï¼š$VERSION"

          mkdir -p release

          # æ„å»ºè¾“å‡ºç›®å½•åç§°
          temp_dir="release/${{ env.BINARY_NAME }}-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}"
          mkdir -p "${temp_dir}"

          # æ ¹æ®ç³»ç»Ÿç±»å‹å†³å®šæ–‡ä»¶ååç¼€ï¼ˆWindows éœ€ .exeï¼‰
          binary_name="${{ env.BINARY_NAME }}"
          if [ "${{ matrix.os }}" = "windows" ]; then
            binary_name="${binary_name}.exe"
          fi

          echo "å¼€å§‹ç¼–è¯‘ -> OS: ${{ matrix.os }} / ARCH: ${{ matrix.arch }}"
          GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} \
          go build \
            -trimpath \
            -ldflags="-s -w -X main.Version=${VERSION}" \
            -o "${temp_dir}/${binary_name}" \
            .

          echo "ç¼–è¯‘å®Œæˆï¼Œå¼€å§‹æ‰“åŒ…å‹ç¼©..."

          cd release
          zip_file="${{ env.BINARY_NAME }}-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}.zip"
          # ä½¿ç”¨ -j å‚æ•°å»é™¤è·¯å¾„ä¿¡æ¯ï¼Œç¡®ä¿è§£å‹åç›´æ¥æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶
          zip -9 "${zip_file}" -j "$(basename ${temp_dir})/${binary_name}"

          echo "ç”Ÿæˆæ ¡éªŒå’Œ..."
          sha256sum "${zip_file}" | tee -a "checksums-${{ matrix.os }}-${{ matrix.arch }}.txt"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© ğŸ“¤
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}-${{ matrix.arch }}
          path: release
          retention-days: 1

################################################################################
# Job 4: Docker æ„å»ºä¸æ¨é€ï¼ˆğŸ³ï¼‰
#  - ä»…åœ¨æ‰‹åŠ¨è§¦å‘ (workflow_dispatch) æ—¶è¿›è¡Œ
#  - æ ¹æ® release_type=Beta æˆ– release_type=Releases æ¨é€å¯¹åº” Docker æ ‡ç­¾ï¼ˆbeta/latestï¼‰
################################################################################
  docker:
    name: Docker æ„å»ºä¸æ¨é€ ğŸ³
    needs: [version, lint]
    if: ${{ github.event_name == 'workflow_dispatch' }}  # ä»…æ‰‹åŠ¨è§¦å‘æ—¶æ‰æ‰§è¡Œ

    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç  ğŸ“¥
        uses: actions/checkout@v4

      - name: è®¾ç½® QEMU (å¤šæ¶æ„æ”¯æŒ)
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub ğŸ”‘
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ (é¢„å‘å¸ƒ / Beta)
        if: ${{ needs.version.outputs.is_release != 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ env.PLATFORMS }}
          push: true
          # ä¸ä½¿ç”¨æ„å»ºç¼“å­˜
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ needs.version.outputs.final_version }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:beta
          build-args: |
            VERSION=${{ needs.version.outputs.final_version }}
            GO_VERSION=${{ env.GO_VERSION }}

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ (æ­£å¼å‘å¸ƒ / Releases)
        if: ${{ needs.version.outputs.is_release == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ env.PLATFORMS }}
          push: true
          # ä¸ä½¿ç”¨æ„å»ºç¼“å­˜
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ needs.version.outputs.final_version }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest
          build-args: |
            VERSION=${{ needs.version.outputs.final_version }}
            GO_VERSION=${{ env.GO_VERSION }}

################################################################################
# Job 5: åˆ›å»º GitHub Release
#  - ä»…åœ¨æ‰‹åŠ¨è§¦å‘æ—¶æ‰§è¡Œ
#  - è‡ªåŠ¨æ”¶é›†å¹¶ä¸Šä¼ å¤šå¹³å°æ„å»ºäº§ç‰©
#  - æ ¹æ® release_type=Beta/Releases æ¥å†³å®šå‘å¸ƒç±»å‹ï¼ˆé¢„å‘å¸ƒæˆ–æ­£å¼å‘å¸ƒï¼‰
################################################################################
  release:
    name: åˆ›å»ºå‘å¸ƒ ğŸ“¢
    needs: [version, build, docker]
    if: ${{ github.event_name == 'workflow_dispatch' }}

    runs-on: ubuntu-latest

    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰© ğŸ“¥
        uses: actions/download-artifact@v4
        with:
          path: release
          pattern: build-*
          merge-multiple: true

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶ ğŸ—‚
        run: |
          mkdir -p final_release
          # æ”¶é›†æ‰€æœ‰ ZIP åŒ…
          find release -name "*.zip" -exec cp {} final_release/ \;

          # æ”¶é›†å¹¶åˆå¹¶æ ¡éªŒå’Œ
          find release -name "checksums-*.txt" -exec cat {} >> final_release/checksums.txt \;

          ############################################################################
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          ############################################################################
          {
            # åˆ¤æ–­æ˜¯æ­£å¼å‘å¸ƒ(Releases)è¿˜æ˜¯é¢„å‘å¸ƒ(Beta)
            if [ "${{ needs.version.outputs.is_release }}" = "true" ]; then
              echo "# ğŸš€ æ­£å¼å‘å¸ƒ ${{ needs.version.outputs.final_version }}"
            else
              echo "# ğŸš§ é¢„å‘å¸ƒ ${{ needs.version.outputs.final_version }}"
            fi
            echo ""

            echo "## ğŸ“¦ æ”¯æŒçš„å¹³å°"
            echo "- Linux (AMD64, ARM64)"
            echo "- macOS (AMD64, ARM64)"
            echo "- Windows (AMD64, ARM64)"
            echo "- FreeBSD (AMD64, ARM64)"
            echo ""

            echo "## ğŸ³ Docker é•œåƒ"
            echo "æ”¯æŒå¤šæ¶æ„ï¼šAMD64, ARM64"
            echo ""
            if [ "${{ needs.version.outputs.is_release }}" = "true" ]; then
              echo "### å¦‚ä½•æ‹‰å–æœ€æ–°ç¨³å®šç‰ˆï¼Ÿ"
              echo "\`\`\`bash"
              echo "docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest"
              echo "docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ needs.version.outputs.final_version }}"
              echo "\`\`\`"
            else
              echo "### å¦‚ä½•æ‹‰å–æµ‹è¯•ç‰ˆï¼Ÿ"
              echo "\`\`\`bash"
              echo "docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:beta"
              echo "docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ needs.version.outputs.final_version }}"
              echo "\`\`\`"
            fi
            echo ""

            echo "## ğŸ”‘ SHA256 æ ¡éªŒå’Œ"
            cat final_release/checksums.txt
          } > final_release/release_notes.md

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.final_version }}
          files: |
            final_release/*.zip
            final_release/checksums.txt
          body_path: final_release/release_notes.md
          draft: false
          # è‹¥æ˜¯é¢„å‘å¸ƒ (Beta) åˆ™è®¾ç½®ä¸º trueï¼Œè‹¥æ˜¯æ­£å¼å‘å¸ƒ (Releases) åˆ™ä¸º false
          prerelease: ${{ needs.version.outputs.is_release != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
